<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Incidencias - Maestros</title>
<link rel="icon" type="image/png" href="./logo.png">
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
min-height: 100vh;
padding: 20px;
display: flex;
align-items: center;
justify-content: center;
}

.container {
background: white;
border-radius: 20px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
max-width: 800px;
width: 100%;
overflow: hidden;
}

.header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 30px;
text-align: center;
}

.header h1 {
font-size: 2em;
margin-bottom: 10px;
}

.header p {
color: #4a9eff;
font-size: 1.1em;
}

.content {
padding: 40px;
}

.alert {
padding: 15px 20px;
border-radius: 10px;
margin-bottom: 25px;
display: none;
animation: slideIn 0.3s;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateY(-10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.alert-success {
background: #d1fae5;
color: #065f46;
border-left: 4px solid #10b981;
}

.alert-error {
background: #fee2e2;
color: #991b1b;
border-left: 4px solid #ef4444;
}

.form-group {
margin-bottom: 25px;
}

label {
display: block;
margin-bottom: 8px;
color: #1f2937;
font-weight: 600;
font-size: 0.95em;
}

input[type="datetime-local"],
input[type="text"],
select,
textarea {
width: 100%;
padding: 12px 15px;
border: 2px solid #e5e7eb;
border-radius: 10px;
font-size: 1em;
transition: all 0.3s;
font-family: inherit;
}

input:focus,
select:focus,
textarea:focus {
outline: none;
border-color: #2a5298;
box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
}

select:disabled {
background: #f3f4f6;
color: #9ca3af;
cursor: not-allowed;
}

textarea {
resize: vertical;
min-height: 120px;
}

.autocomplete-container {
position: relative;
}

.suggestions {
position: absolute;
top: 100%;
left: 0;
right: 0;
background: white;
border: 2px solid #e5e7eb;
border-top: none;
border-radius: 0 0 10px 10px;
max-height: 250px;
overflow-y: auto;
display: none;
z-index: 1000;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.suggestion-item {
padding: 12px 15px;
cursor: pointer;
transition: background 0.2s;
border-bottom: 1px solid #f3f4f6;
}

.suggestion-item:last-child {
border-bottom: none;
}

.suggestion-item:hover {
background: #f3f4f6;
}

.suggestion-name {
font-weight: 600;
color: #1f2937;
}

.suggestion-course {
font-size: 0.85em;
color: #6b7280;
margin-left: 8px;
}

.btn {
width: 100%;
padding: 15px;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
color: white;
border: none;
border-radius: 10px;
font-size: 1.1em;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
margin-top: 10px;
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 10px 20px rgba(42, 82, 152, 0.3);
}

.btn:active {
transform: translateY(0);
}

.btn:disabled {
background: #9ca3af;
cursor: not-allowed;
transform: none;
}

.required {
color: #dc2626;
}

.form-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
}

@media (max-width: 768px) {
.form-row {
grid-template-columns: 1fr;
}

.content {
padding: 25px;
}

.header h1 {
font-size: 1.5em;
}
}

.loading {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid rgba(255,255,255,.3);
border-radius: 50%;
border-top-color: white;
animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üìã Registro de Incidencias</h1>
<p>Sistema de Gesti√≥n de Convivencia - CENSA</p>
</div>

<div class="content">
<div style="background:#f0fdf4;border-left:4px solid #059669;padding:12px 15px;margin-bottom:25px;border-radius:8px;">
<strong style="color:#059669;display:block;margin-bottom:6px;font-size:0.95em;">Instrucciones:</strong>
<div style="color:#065f46;font-size:0.85em;line-height:1.6;">
<p style="margin:0 0 8px 0;">- Complete todos los campos marcados con <span style="color:#dc2626;font-weight:bold;">*</span>.</p>
<p style="margin:0 0 8px 0;">- Al escribir el nombre del estudiante, ver√° sugerencias autom√°ticas.</p>
<p style="margin:0;">- Seleccione el nombre correcto y el curso se completar√° autom√°ticamente.</p>
</div>
</div>

<div class="alert alert-success" id="alertSuccess">
‚úÖ <strong>¬°Incidencia registrada exitosamente!</strong>
</div>

<div class="alert alert-error" id="alertError">
‚ùå <strong>Error:</strong> <span id="errorMessage"></span>
</div>

<form id="formIncidencia">
<div class="form-group">
<label for="fechaIncidencia">Fecha y Hora <span class="required">*</span></label>
<input type="datetime-local" id="fechaIncidencia" required>
</div>

<div class="form-group autocomplete-container">
<label for="nombreEstudiante">Nombre del Estudiante <span class="required">*</span></label>
<input 
type="text" 
id="nombreEstudiante" 
placeholder="Escriba el nombre del estudiante..."
required
autocomplete="off"
>
<div class="suggestions" id="suggestions"></div>
</div>

<div class="form-group">
<label for="cursoIncidencia">Curso <span class="required">*</span></label>
<select id="cursoIncidencia" required>
<option value="">Seleccione un curso</option>
<option value="1roA">1roA</option>
<option value="1roB">1roB</option>
<option value="1roC">1roC</option>
<option value="2doA">2doA</option>
<option value="2doB">2doB</option>
<option value="2doC">2doC</option>
<option value="3roA">3roA</option>
<option value="3roB">3roB</option>
<option value="3roC">3roC</option>
<option value="4toA">4toA</option>
<option value="4toB">4toB</option>
<option value="4toC">4toC</option>
<option value="5toA">5toA</option>
<option value="5toB">5toB</option>
<option value="5toC">5toC</option>
<option value="6toA">6toA</option>
<option value="6toB">6toB</option>
<option value="6toC">6toC</option>
</select>
</div>

<div class="form-group">
<label for="tipoFalta">Tipo de Falta <span class="required">*</span></label>
<select id="tipoFalta" required>
<option value="">Seleccione el tipo</option>
<option value="Leve">Leve</option>
<option value="Grave">Grave</option>
<option value="Muy Grave">Muy Grave</option>
</select>
</div>

<div class="form-row">
<div class="form-group">
<label for="docenteReporta">Docente que Reporta <span class="required">*</span></label>
<input 
type="text" 
id="docenteReporta" 
placeholder="Su nombre completo"
required
>
</div>

<div class="form-group">
<label for="tipoConducta">Tipo de Conducta <span class="required">*</span></label>
<select id="tipoConducta" required>
<option value="">Seleccione el tipo</option>
<option value="Agresi√≥n f√≠sica">Agresi√≥n f√≠sica</option>
<option value="Agresi√≥n verbal">Agresi√≥n verbal</option>
<option value="Bullying">Bullying</option>
<option value="Cyber bullying">Cyber bullying</option>
<option value="Indisciplina en el aula">Indisciplina en el aula</option>
<option value="Llegada tarde al aula">Llegada tarde al aula</option>
<option value="Salir sin permiso del aula">Salir sin permiso del aula</option>
<option value="Falta de respeto a compa√±eros">Falta de respeto a compa√±eros</option>
<option value="Falta de respeto al maestro/a">Falta de respeto al maestro/a</option>
<option value="Desaf√≠o de la autoridad">Desaf√≠o de la autoridad</option>
<option value="Reincidencia por uniformidad">Reincidencia por uniformidad</option>
<option value="Corte de pelo no permitido">Corte de pelo no permitido</option>
<option value="Peinado no permitido">Peinado no permitido</option>
<option value="Salida del centro sin autorizaci√≥n">Salida del centro sin autorizaci√≥n</option>
<option value="Uso de dispositivos tecnol√≥gicos sin autorizaci√≥n">Uso de dispositivos tecnol√≥gicos sin autorizaci√≥n</option>
<option value="Otros">Otros</option>
</select>
</div>
</div>

<div class="form-group">
<label for="descripcion">Descripci√≥n de la Incidencia <span class="required">*</span></label>
<textarea 
id="descripcion" 
placeholder="Describa detalladamente lo sucedido..."
required
></textarea>
</div>

<div class="form-group">
<label for="accionesDocente">Acciones Tomadas por el Docente <span class="required">*</span></label>
<textarea 
id="accionesDocente" 
placeholder="Describa las acciones que tom√≥ para manejar la situaci√≥n..."
></textarea>
</div>

<button type="submit" class="btn" id="btnSubmit">
Registrar Incidencia
</button>
</form>
</div>
</div>

<!-- üÜï SISTEMA DE NOTIFICACIONES (incrustado) -->
<script>
// ========================================
// SISTEMA DE NOTIFICACIONES - GOOGLE SHEETS
// VERSI√ìN CORREGIDA - Sin onclick inline
// Compatible con iOS/Android/Desktop
// ========================================

// üëâ CONFIGURACI√ìN DE URL
let urlNotificaciones = 'https://script.google.com/macros/s/AKfycbxza27B1vj81BpWe_8qrsQusxE0YC2FzoY1j4yAKkG3uq89gA1xIljm3PuWCQljJojZ2Q/exec';

// Variables globales
let datosNotificaciones = [];
let sistemaNotificacionesSheets = null;
let intervaloActualizacionNotificaciones = null;
let intervaloActualizacionBackground = null;

// ========================================
// FUNCI√ìN AUXILIAR
// ========================================

function esNotificacionLeida(notif) {
    const valor = String(notif.Leida).toLowerCase();
    return valor === 'true';
}

// ========================================
// CLASE PRINCIPAL
// ========================================

class NotificacionesGoogleSheets {
    constructor() {
        this.url = urlNotificaciones;
        this.usuarioActual = this.obtenerUsuario();
    }

    obtenerUsuario() {
        let usuario = localStorage.getItem('usuario_ugc');
        if (!usuario) {
            usuario = `Usuario_${Date.now()}_${Math.random().toString(36).substring(7)}`;
            localStorage.setItem('usuario_ugc', usuario);
        }
        return usuario;
    }

    async cargarNotificaciones(silencioso = false) {
        if (!this.url) return [];

        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`${this.url}?action=leer&t=${timestamp}`);
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && Array.isArray(data.data)) {
                    const cantidadAnterior = datosNotificaciones.length;
                    datosNotificaciones = data.data;
                    
                    if (!silencioso && datosNotificaciones.length > cantidadAnterior) {
                        this.animarBadgeNuevas();
                    }
                    
                    actualizarPanelNotificaciones();
                    actualizarContadoresNotificaciones();
                    return data.data;
                }
            }
        } catch (error) {
            if (!silencioso) {
                console.error('Error al cargar notificaciones:', error);
            }
        }
        return [];
    }

    animarBadgeNuevas() {
        const badge = document.getElementById('notifCounter');
        if (badge && badge.style.display !== 'none') {
            badge.style.animation = 'none';
            setTimeout(() => {
                badge.style.animation = 'pulse 0.5s ease-in-out 3';
            }, 10);
        }
    }

    async crearNotificacion(tipo, titulo, mensaje, prioridad = 'info', destinatario = 'todos') {
        if (!this.url) return false;

        const notificacion = {
            ID_Unico: this.generarIdUnico(tipo, mensaje),
            Tipo: tipo,
            Titulo: titulo,
            Mensaje: mensaje,
            Prioridad: prioridad,
            Timestamp: new Date().toISOString(),
            Leida: 'false',
            Usuario: destinatario
        };

        try {
            const formData = new URLSearchParams();
            formData.append('action', 'agregar');
            
            for (const key in notificacion) {
                formData.append(key, notificacion[key]);
            }

            fetch(this.url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            }).catch(error => {
                console.log('Error al enviar:', error);
            });

            // Solo recargar panel si existe en esta p√°gina
            if (document.getElementById('notifPanel')) {
                setTimeout(() => this.cargarNotificaciones(true), 1000);
            }
            return true;
        } catch (error) {
            console.error('Error al crear notificaci√≥n:', error);
            return false;
        }
    }

    async marcarComoLeida(idUnico) {
        if (!this.url) return false;

        try {
            console.log('üîµ [JS] Iniciando marcar como le√≠da:', idUnico);
            
            // 1. Actualizar localmente PRIMERO
            const notif = datosNotificaciones.find(n => n.ID_Unico === idUnico);
            if (notif) {
                console.log('‚úÖ [JS] Encontrada localmente');
                notif.Leida = 'true';
                actualizarPanelNotificaciones();
            } else {
                console.warn('‚ö†Ô∏è [JS] No encontrada localmente');
            }

            // 2. Enviar a Google Sheets (IGUAL QUE marcarTodasLeidas)
            const formData = new URLSearchParams();
            formData.append('action', 'marcarLeida');
            formData.append('idUnico', idUnico);

            console.log('üì§ [JS] Enviando a Google Sheets...');

            fetch(this.url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            }).catch(error => {
                console.log('Error al enviar:', error);
            });

            // 3. Recargar despu√©s de 3 segundos
            setTimeout(() => this.cargarNotificaciones(true), 3000);

            return true;
        } catch (error) {
            console.error('Error al marcar como le√≠da:', error);
            return false;
        }
    }

    async eliminarNotificacion(idUnico) {
        if (!this.url) return false;

        try {
            datosNotificaciones = datosNotificaciones.filter(n => n.ID_Unico !== idUnico);
            actualizarPanelNotificaciones();

            const formData = new URLSearchParams();
            formData.append('action', 'eliminar');
            formData.append('idUnico', idUnico);

            fetch(this.url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            }).catch(error => {
                console.log('Error al enviar:', error);
            });

            setTimeout(() => this.cargarNotificaciones(true), 3000);

            return true;
        } catch (error) {
            console.error('Error al eliminar:', error);
            return false;
        }
    }

    async marcarTodasLeidas() {
        if (!this.url) return false;

        try {
            datosNotificaciones.forEach(n => {
                if (n.Usuario === 'todos' || n.Usuario === this.usuarioActual) {
                    n.Leida = 'true';
                }
            });
            actualizarPanelNotificaciones();

            const formData = new URLSearchParams();
            formData.append('action', 'marcarTodasLeidas');
            formData.append('usuario', this.usuarioActual);

            fetch(this.url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            }).catch(error => {
                console.log('Error al enviar:', error);
            });

            setTimeout(() => this.cargarNotificaciones(true), 3000);

            return true;
        } catch (error) {
            console.error('Error al marcar todas:', error);
            return false;
        }
    }

    async limpiarLeidas() {
        if (!this.url) return false;

        try {
            datosNotificaciones = datosNotificaciones.filter(n => {
                if (n.Usuario === 'todos' || n.Usuario === this.usuarioActual) {
                    return !esNotificacionLeida(n);
                }
                return true;
            });
            actualizarPanelNotificaciones();

            const formData = new URLSearchParams();
            formData.append('action', 'limpiarLeidas');
            formData.append('usuario', this.usuarioActual);

            fetch(this.url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            }).catch(error => {
                console.log('Error al enviar:', error);
            });

            setTimeout(() => this.cargarNotificaciones(true), 3000);

            return true;
        } catch (error) {
            console.error('Error al limpiar:', error);
            return false;
        }
    }

    generarIdUnico(tipo, contenido) {
        const texto = `${tipo}-${contenido}-${Date.now()}`;
        return texto.toLowerCase().replace(/[^a-z0-9-]/g, '-').substring(0, 100);
    }

    obtenerMisNotificaciones() {
        return datosNotificaciones.filter(n => 
            n.Usuario === 'todos' || n.Usuario === this.usuarioActual
        );
    }

    obtenerNoLeidas() {
        return this.obtenerMisNotificaciones().filter(n => !esNotificacionLeida(n));
    }
}

// ========================================
// INTERFAZ DE USUARIO
// ========================================

function toggleNotificacionesSheets() {
    const panel = document.getElementById('notifPanel');
    const overlay = document.getElementById('notifOverlay');
    
    panel.classList.toggle('active');
    overlay.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        if (!sistemaNotificacionesSheets) {
            inicializarSistemaNotificaciones();
        }
        
        if (!urlNotificaciones) {
            mostrarModalConfirmacion(
                '‚öôÔ∏è Configuraci√≥n pendiente',
                'Ve a <strong>Configuraci√≥n del Sistema</strong> y agrega la URL de Google Sheets.',
                false,
                null,
                'Entendido'
            );
            panel.classList.remove('active');
            overlay.classList.remove('active');
            return;
        }
        
        const tabs = document.querySelectorAll('.notif-tab');
        tabs.forEach(t => t.classList.remove('active'));
        const tabTodas = document.querySelector('.notif-tab[data-tab="todas"]');
        if (tabTodas) tabTodas.classList.add('active');
        
        mostrarIndicadorActualizacion(true);
        
        sistemaNotificacionesSheets.cargarNotificaciones().then(() => {
            mostrarIndicadorActualizacion(false);
        });
    }
}

function mostrarIndicadorActualizacion(mostrar) {
    const header = document.querySelector('.notif-header h3');
    if (!header) return;
    
    let indicador = document.getElementById('indicadorActualizacion');
    
    if (mostrar) {
        if (!indicador) {
            indicador = document.createElement('span');
            indicador.id = 'indicadorActualizacion';
            indicador.style.cssText = `
                display: inline-block;
                margin-left: 10px;
                color: #059669;
                font-size: 14px;
                animation: pulse 1s ease-in-out infinite;
            `;
            indicador.textContent = 'üîÑ';
            header.appendChild(indicador);
        }
        indicador.style.display = 'inline-block';
    } else {
        if (indicador) {
            indicador.style.display = 'none';
        }
    }
}

// ========================================
// üÜï NUEVA FUNCI√ìN: Manejar clic en notificaci√≥n
// ========================================

function manejarClickNotificacion(event) {
    const notifItem = event.currentTarget;
    const idUnico = notifItem.dataset.idUnico;
    
    // Si ya est√° le√≠da, no hacer nada
    if (notifItem.classList.contains('leida')) {
        console.log('üö´ [CLICK] Notificaci√≥n ya le√≠da, ignorando');
        return;
    }
    
    console.log('üëÜ [CLICK] Notificaci√≥n clickeada:', idUnico);
    
    if (sistemaNotificacionesSheets && idUnico) {
        sistemaNotificacionesSheets.marcarComoLeida(idUnico);
    }
}

function mostrarNotificacionesSheets(filtro = 'todas') {
    const content = document.getElementById('notifContent');
    if (!content) return;
    
    if (!sistemaNotificacionesSheets) {
        content.innerHTML = `
            <div style="text-align:center;padding:60px 20px;color:#999;">
                <div style="font-size:64px;margin-bottom:20px;">‚öôÔ∏è</div>
                <p style="font-size:18px;margin-bottom:10px;">Sistema no inicializado</p>
                <p style="font-size:14px;">Configura la URL en Configuraci√≥n del Sistema</p>
            </div>
        `;
        return;
    }
    
    const misNotificaciones = sistemaNotificacionesSheets.obtenerMisNotificaciones();
    
    let notifFiltradas = misNotificaciones;
    if (filtro === 'sin-leer') {
        notifFiltradas = misNotificaciones.filter(n => !esNotificacionLeida(n));
    } else if (filtro === 'leidas') {
        notifFiltradas = misNotificaciones.filter(n => esNotificacionLeida(n));
    }
    
    if (notifFiltradas.length === 0) {
        const mensajes = {
            'todas': { emoji: 'üì≠', texto: 'No hay notificaciones' },
            'sin-leer': { emoji: '‚úÖ', texto: 'No hay notificaciones sin leer' },
            'leidas': { emoji: 'üì≠', texto: 'No hay notificaciones le√≠das' }
        };
        const msg = mensajes[filtro] || mensajes['todas'];
        
        content.innerHTML = `
            <div style="text-align:center;padding:60px 20px;color:#999;">
                <div style="font-size:64px;margin-bottom:20px;">${msg.emoji}</div>
                <p style="font-size:18px;">${msg.texto}</p>
            </div>
        `;
        return;
    }
    
    notifFiltradas.sort((a, b) => {
        const fechaA = new Date(a.Timestamp || 0);
        const fechaB = new Date(b.Timestamp || 0);
        return fechaB - fechaA;
    });
    
    // üÜï RENDERIZAR SIN ONCLICK INLINE
    content.innerHTML = notifFiltradas.map(notif => {
        const prioridad = notif.Prioridad || 'info';
        const leida = esNotificacionLeida(notif);
        const fecha = new Date(notif.Timestamp);
        const fechaTexto = fecha.toLocaleDateString('es-DO', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const iconosPrioridad = {
            'urgente': 'üö®',
            'importante': '‚ö†Ô∏è',
            'info': '‚ÑπÔ∏è'
        };
        
        const colorBorde = {
            'urgente': '#dc3545',
            'importante': '#ffc107',
            'info': '#0d6efd'
        };
        
        const estiloNotif = leida 
            ? `background: #f8f9fa; opacity: 0.85; border-left: 4px solid #6c757d;`
            : `background: white; border-left: 4px solid ${colorBorde[prioridad]}; cursor: pointer;`;
        
        return `
            <div class="notif-item ${leida ? 'leida' : 'sin-leer'}" 
                 data-id-unico="${notif.ID_Unico}"
                 style="${estiloNotif}">
                <div class="notif-header-item">
                    <span class="notif-badge-type badge-${prioridad}">
                        ${iconosPrioridad[prioridad]} ${prioridad.toUpperCase()}
                    </span>
                    <span class="notif-fecha">${fechaTexto}</span>
                    ${leida ? '<span class="notif-estado-leida">‚úì Le√≠da</span>' : ''}
                </div>
                <h4 class="notif-titulo" style="${leida ? 'color: #6c757d;' : ''}">${notif.Titulo}</h4>
                <p class="notif-mensaje" style="${leida ? 'color: #868e96;' : ''}">${notif.Mensaje}</p>
                <div class="notif-acciones">
                    ${!leida ? '<span class="notif-nuevo">üÜï NUEVA</span>' : '<span class="notif-archivada">üìÇ Archivada</span>'}
                    <button class="btn-eliminar-notif" data-id="${notif.ID_Unico}">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // üÜï AGREGAR EVENT LISTENERS despu√©s de renderizar
    agregarEventListeners();
}

// üÜï NUEVA FUNCI√ìN: Agregar event listeners
function agregarEventListeners() {
    // Event listeners para notificaciones
    document.querySelectorAll('.notif-item.sin-leer').forEach(item => {
        item.addEventListener('click', manejarClickNotificacion);
    });
    
    // Event listeners para botones eliminar
    document.querySelectorAll('.btn-eliminar-notif').forEach(btn => {
        btn.addEventListener('click', function(event) {
            event.stopPropagation();
            const idUnico = this.dataset.id;
            eliminarNotifSheets(idUnico);
        });
    });
}

function actualizarPanelNotificaciones() {
    if (!document.getElementById('notifPanel')) return; // No existe en esta p√°gina
    const tabActiva = document.querySelector('.notif-tab.active');
    const filtro = tabActiva ? tabActiva.getAttribute('data-tab') : 'todas';
    
    mostrarNotificacionesSheets(filtro);
    actualizarContadoresNotificaciones();
}

function actualizarContadoresNotificaciones() {
    if (!sistemaNotificacionesSheets) return;
    
    const misNotificaciones = sistemaNotificacionesSheets.obtenerMisNotificaciones();
    const total = misNotificaciones.length;
    const noLeidas = misNotificaciones.filter(n => !esNotificacionLeida(n)).length;
    const leidas = total - noLeidas;
    
    const badge = document.getElementById('notifCounter');
    if (badge) {
        badge.textContent = noLeidas;
        badge.style.display = noLeidas > 0 ? 'flex' : 'none';
    }
    
    const countTodas = document.getElementById('countTodas');
    const countSinLeer = document.getElementById('countSinLeer');
    const countLeidas = document.getElementById('countLeidas');
    
    if (countTodas) countTodas.textContent = total;
    if (countSinLeer) countSinLeer.textContent = noLeidas;
    if (countLeidas) countLeidas.textContent = leidas;
}

function cambiarTabNotifSheets(tab) {
    const tabs = document.querySelectorAll('.notif-tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    mostrarNotificacionesSheets(tab);
}

async function eliminarNotifSheets(idUnico) {
    if (!sistemaNotificacionesSheets) return;
    
    const notif = datosNotificaciones.find(n => n.ID_Unico === idUnico);
    if (!notif) return;
    
    mostrarModalConfirmacion(
        'üóëÔ∏è Eliminar notificaci√≥n',
        `¬øEst√°s seguro de que deseas eliminar esta notificaci√≥n?<br><br><strong>${notif.Titulo}</strong>`,
        true,
        async function() {
            await sistemaNotificacionesSheets.eliminarNotificacion(idUnico);
            mostrarNotificacionToast('‚úÖ Notificaci√≥n eliminada');
        }
    );
}

async function marcarTodasNotifLeidas() {
    if (!sistemaNotificacionesSheets) return;
    
    await sistemaNotificacionesSheets.marcarTodasLeidas();
    mostrarNotificacionToast('‚úÖ Todas marcadas como le√≠das');
}

async function limpiarNotifLeidas() {
    if (!sistemaNotificacionesSheets) return;
    
    const misNotificaciones = sistemaNotificacionesSheets.obtenerMisNotificaciones();
    const cantidadLeidas = misNotificaciones.filter(n => esNotificacionLeida(n)).length;
    
    if (cantidadLeidas === 0) {
        mostrarModalConfirmacion(
            'üì≠ Sin notificaciones le√≠das',
            'No hay notificaciones le√≠das para eliminar.',
            false,
            null,
            'Entendido'
        );
        return;
    }
    
    mostrarModalConfirmacion(
        'üóëÔ∏è Limpiar notificaciones',
        `¬øEst√°s seguro de que deseas eliminar <strong>${cantidadLeidas}</strong> notificaci√≥n${cantidadLeidas > 1 ? 'es' : ''} le√≠da${cantidadLeidas > 1 ? 's' : ''}?`,
        true,
        async function() {
            await sistemaNotificacionesSheets.limpiarLeidas();
            mostrarNotificacionToast('‚úÖ Notificaciones eliminadas');
        }
    );
}

// ========================================
// FUNCIONES DE CREACI√ìN
// ========================================

async function notificarNuevaIncidencia(estudiante, tipoFalta, tipoConducta, docente, curso) {
    // Si no est√° inicializado, intentar inicializar ahora
    if (!sistemaNotificacionesSheets) {
        console.log('‚ö†Ô∏è sistemaNotificacionesSheets no inicializado, intentando inicializar...');
        inicializarSistemaNotificaciones();
        // Esperar un momento para que se inicialice
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    if (!sistemaNotificacionesSheets) {
        console.warn('‚ùå No se pudo inicializar el sistema de notificaciones');
        return;
    }
    
    // TODAS las incidencias son importantes (badge amarillo)
    const prioridad = 'importante';
    
    const cursoTexto = curso ? ` | Curso: <strong>${curso}</strong>` : '';
    const docenteTexto = docente ? ` | Docente: <strong>${docente}</strong>` : '';
    
    await sistemaNotificacionesSheets.crearNotificacion(
        'incidencia',
        'Nueva incidencia registrada',
        `Se ha registrado una <strong>Falta ${tipoFalta}</strong> para <strong>${estudiante}</strong> por ${tipoConducta}${cursoTexto}${docenteTexto}.`,
        prioridad,
        'todos'
    );
}

async function notificarNuevoContacto(estudiante, nombrePadre, nombreMadre) {
    if (!sistemaNotificacionesSheets) return;
    
    let contactosRegistrados = [];
    if (nombrePadre) contactosRegistrados.push('Padre');
    if (nombreMadre) contactosRegistrados.push('Madre');
    
    const textContactos = contactosRegistrados.length > 0 
        ? contactosRegistrados.join(' y ') 
        : 'Contacto de emergencia';
    
    await sistemaNotificacionesSheets.crearNotificacion(
        'contacto',
        'Nuevo contacto registrado',
        `Se ha registrado el contacto de <strong>${textContactos}</strong> para el estudiante <strong>${estudiante}</strong>.`,
        'info',
        'todos'
    );
}

async function notificarTardanzasCriticas(estudiante, cantidad) {
    if (!sistemaNotificacionesSheets) return;
    
    const idUnico = `tardanzas-${estudiante}-${cantidad}-${new Date().getMonth()}-${new Date().getFullYear()}`;
    
    const existe = datosNotificaciones.some(n => n.ID_Unico === idUnico);
    if (existe) return;
    
    await sistemaNotificacionesSheets.crearNotificacion(
        'tardanzas',
        'Estudiante con 3 tardanzas',
        `<strong>${estudiante}</strong> ha alcanzado ${cantidad} tardanzas este mes.`,
        'urgente',
        'todos'
    );
}

// ========================================
// INICIALIZACI√ìN
// ========================================

function inicializarSistemaNotificaciones() {
    try {
        if (typeof CONFIG !== 'undefined' && CONFIG && CONFIG.urlNotificaciones) {
            urlNotificaciones = CONFIG.urlNotificaciones;
        }
        
        if (urlNotificaciones) {
            sistemaNotificacionesSheets = new NotificacionesGoogleSheets();
            
            sistemaNotificacionesSheets.cargarNotificaciones(true).catch(error => {
                console.log('Error al cargar inicial:', error);
            });
            
            if (intervaloActualizacionNotificaciones) {
                clearInterval(intervaloActualizacionNotificaciones);
            }
            if (intervaloActualizacionBackground) {
                clearInterval(intervaloActualizacionBackground);
            }
            
            intervaloActualizacionNotificaciones = setInterval(() => {
                try {
                    const panel = document.getElementById('notifPanel');
                    if (panel && panel.classList.contains('active') && sistemaNotificacionesSheets) {
                        sistemaNotificacionesSheets.cargarNotificaciones(true).catch(error => {
                            console.log('Error al actualizar:', error);
                        });
                    }
                } catch (error) {
                    console.log('Error en intervalo:', error);
                }
            }, 5000);
            
            intervaloActualizacionBackground = setInterval(() => {
                try {
                    const panel = document.getElementById('notifPanel');
                    if ((!panel || !panel.classList.contains('active')) && sistemaNotificacionesSheets) {
                        sistemaNotificacionesSheets.cargarNotificaciones(true).catch(error => {
                            console.log('Error en background:', error);
                        });
                    }
                } catch (error) {
                    console.log('Error en background:', error);
                }
            }, 15000);
            
            console.log('‚úÖ Sistema de notificaciones inicializado');
            console.log('üîß Usando EVENT LISTENERS (no onclick inline)');
            console.log('‚ö° Actualizaci√≥n: 5s | 15s');
        }
    } catch (error) {
        console.log('‚ùå Error al inicializar:', error);
    }
}

function actualizarURLNotificaciones(nuevaURL) {
    urlNotificaciones = nuevaURL;
    if (typeof CONFIG !== 'undefined' && CONFIG) {
        CONFIG.urlNotificaciones = nuevaURL;
    }
    inicializarSistemaNotificaciones();
}

// ========================================
// FUNCIONES AUXILIARES
// ========================================

if (typeof mostrarModalConfirmacion === 'undefined') {
    function mostrarModalConfirmacion(titulo, mensaje, mostrarCancelar, callbackConfirmar, textoConfirmar = 'Confirmar') {
        if (confirm(mensaje.replace(/<[^>]*>/g, ''))) {
            if (callbackConfirmar) callbackConfirmar();
        }
    }
}

if (typeof mostrarNotificacionToast === 'undefined') {
    function mostrarNotificacionToast(mensaje) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #059669;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.4);
            z-index: 100000;
            font-weight: 600;
        `;
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) document.body.removeChild(toast);
        }, 3000);
    }
}

// ========================================
// ESTILOS CSS
// ========================================

const styleSheet = document.createElement('style');
styleSheet.textContent = `
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
    
    .notif-item.sin-leer {
        transition: all 0.3s ease;
    }
    
    .notif-item.sin-leer:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .notif-item.leida {
        transition: all 0.3s ease;
        cursor: default !important;
    }
    
    .notif-item.leida:hover {
        opacity: 1 !important;
    }
    
    .notif-estado-leida {
        display: inline-block;
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
    }
    
    .notif-nuevo {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
        animation: pulse 2s ease-in-out infinite;
    }
    
    .notif-archivada {
        background: #6c757d;
        color: white;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 600;
        opacity: 0.7;
    }
`;
document.head.appendChild(styleSheet);

console.log('‚úÖ Sistema de notificaciones CORREGIDO cargado');
console.log('üîß Event listeners en lugar de onclick inline');
console.log('üöÄ Compatible iOS/Android/Desktop');

</script>

<script>
// ==========================================
// CONFIGURACI√ìN
// ==========================================

const CONFIG = {
urlIncidencias: 'https://script.google.com/macros/s/AKfycbwnCHIHNum-8uCHLbuE5NvwJeVmVMF6hCLWOAQQRUOwsU5GK_vpkrxifDFlMat1tP-z/exec',
urlEstudiantes: 'https://script.google.com/macros/s/AKfycby-ceKgHZzTxQzcVcNiOWaN5aNDoqtIlihVcOZAp0_5hIVcv115GKHtfdjFPq43ttCEuA/exec',
urlAppsScript: 'https://script.google.com/macros/s/AKfycbyQ7veYDEtfslxTrulAYaXQvX0pgBhAhL0n5JmBgyQAeJUnaUzjZM-l4hRfiJ4GoBdp/exec',
// üÜï URL de notificaciones
urlNotificaciones: 'https://script.google.com/macros/s/AKfycbxza27B1vj81BpWe_8qrsQusxE0YC2FzoY1j4yAKkG3uq89gA1xIljm3PuWCQljJojZ2Q/exec'
};

// Hacer que urlNotificaciones est√© disponible globalmente
window.urlNotificaciones = CONFIG.urlNotificaciones;

let estudiantes = [];

// ==========================================
// CARGA DE ESTUDIANTES
// ==========================================

async function cargarEstudiantes() {
try {
console.log('üîÑ Cargando estudiantes...');
const response = await fetch(CONFIG.urlEstudiantes);
const data = await response.json();

if (data.values && data.values.length > 1) {
const headers = data.values[0];
estudiantes = data.values.slice(1).map(row => {
const obj = {};
headers.forEach((header, index) => {
obj[header] = row[index] || '';
});
return obj;
});
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados`);
} else if (Array.isArray(data) && data.length > 0) {
estudiantes = data;
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados`);
} else if (data.data && Array.isArray(data.data)) {
estudiantes = data.data;
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados`);
}
} catch (error) {
console.error('‚ùå Error cargando estudiantes:', error);
}
}

// ==========================================
// AUTOCOMPLETADO
// ==========================================

const inputEstudiante = document.getElementById('nombreEstudiante');
const suggestionsDiv = document.getElementById('suggestions');

inputEstudiante.addEventListener('input', function() {
const texto = this.value.toLowerCase().trim();

if (texto.length < 2) {
suggestionsDiv.style.display = 'none';
return;
}

const coincidencias = estudiantes.filter(e => {
const nombre = (e['Nombre Completo'] || e['nombre'] || e['Nombre'] || '').toLowerCase();
return nombre.includes(texto);
}).slice(0, 15);

if (coincidencias.length === 0) {
suggestionsDiv.style.display = 'none';
return;
}

suggestionsDiv.innerHTML = coincidencias.map((e, index) => {
const nombre = e['Nombre Completo'] || e['nombre'] || e['Nombre'] || '';
const curso = e['Curso'] || e['curso'] || '';
return `
<div class="suggestion-item" data-index="${index}">
<span class="suggestion-name">${nombre}</span>
<span class="suggestion-course">(${curso})</span>
</div>
`;
}).join('');

document.querySelectorAll('.suggestion-item').forEach((item, index) => {
item.addEventListener('click', function() {
const estudiante = coincidencias[index];
const nombre = estudiante['Nombre Completo'] || estudiante['nombre'] || estudiante['Nombre'] || '';
const curso = estudiante['Curso'] || estudiante['curso'] || '';
seleccionarEstudiante(nombre, curso);
});
});

suggestionsDiv.style.display = 'block';
});

function seleccionarEstudiante(nombre, curso) {
inputEstudiante.value = nombre;
document.getElementById('cursoIncidencia').value = curso;
suggestionsDiv.style.display = 'none';
}

document.addEventListener('click', function(e) {
if (!e.target.closest('.autocomplete-container')) {
suggestionsDiv.style.display = 'none';
}
});

// ==========================================
// ENV√çO DEL FORMULARIO
// ==========================================

document.getElementById('formIncidencia').addEventListener('submit', async function(e) {
e.preventDefault();

const btnSubmit = document.getElementById('btnSubmit');
const alertSuccess = document.getElementById('alertSuccess');
const alertError = document.getElementById('alertError');

alertSuccess.style.display = 'none';
alertError.style.display = 'none';

btnSubmit.disabled = true;
btnSubmit.innerHTML = '<span class="loading"></span> Guardando...';

try {
const datos = {
'Fecha y Hora': document.getElementById('fechaIncidencia').value,
'Curso': document.getElementById('cursoIncidencia').value,
'Nombre Estudiante': document.getElementById('nombreEstudiante').value,
'Tipo de falta': document.getElementById('tipoFalta').value,
'Docente': document.getElementById('docenteReporta').value,
'Tipo de Conducta': document.getElementById('tipoConducta').value,
'Descripci√≥n': document.getElementById('descripcion').value,
'Acciones Docente': document.getElementById('accionesDocente').value
};

await enviarAGoogleSheets(datos);

// üÜï ENVIAR NOTIFICACI√ìN
console.log('üì¢ Enviando notificaci√≥n...');
if (typeof notificarNuevaIncidencia === 'function') {
await notificarNuevaIncidencia(
datos['Nombre Estudiante'],
datos['Tipo de falta'],
datos['Tipo de Conducta'],
datos['Docente'],
datos['Curso']
);
console.log('‚úÖ Notificaci√≥n enviada');
} else {
console.warn('‚ö†Ô∏è Funci√≥n notificarNuevaIncidencia no disponible');
}

alertSuccess.style.display = 'block';
this.reset();

const now = new Date();
now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
document.getElementById('fechaIncidencia').value = now.toISOString().slice(0, 16);

window.scrollTo({ top: 0, behavior: 'smooth' });

setTimeout(() => {
alertSuccess.style.display = 'none';
}, 5000);

} catch (error) {
console.error('Error:', error);
document.getElementById('errorMessage').textContent = error.message;
alertError.style.display = 'block';
window.scrollTo({ top: 0, behavior: 'smooth' });
} finally {
btnSubmit.disabled = false;
btnSubmit.innerHTML = 'Registrar Incidencia';
}
});

// ==========================================
// FUNCI√ìN PARA ENVIAR A GOOGLE SHEETS
// ==========================================

async function enviarAGoogleSheets(datos) {
try {
const formData = new URLSearchParams();
for (const key in datos) {
formData.append(key, datos[key]);
}

console.log('üì§ Enviando datos a Google Sheets...');

const response = await fetch(CONFIG.urlAppsScript, {
method: 'POST',
body: formData,
redirect: 'follow'
});

console.log('‚úÖ Datos enviados');

await new Promise(resolve => setTimeout(resolve, 1000));

return true;
} catch (error) {
console.error('‚ùå Error enviando:', error);
throw new Error('No se pudo conectar con Google Sheets');
}
}

// ==========================================
// INICIALIZACI√ìN
// ==========================================

window.addEventListener('DOMContentLoaded', () => {
const now = new Date();
now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
document.getElementById('fechaIncidencia').value = now.toISOString().slice(0, 16);

cargarEstudiantes();

// üÜï INICIALIZAR SISTEMA DE NOTIFICACIONES
if (typeof inicializarSistemaNotificaciones === 'function') {
inicializarSistemaNotificaciones();
console.log('‚úÖ Sistema de notificaciones inicializado');
} else {
console.warn('‚ö†Ô∏è Sistema de notificaciones no disponible');
}

console.log('‚úÖ Sistema de incidencias cargado');
});
</script>
</body>
</html>
