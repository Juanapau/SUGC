<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EstadÃ­sticas - Consulta</title>
<link rel="icon" type="image/png" href="./logo.png">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
min-height: 100vh;
padding: 20px;
}

.container { max-width: 1400px; margin: 0 auto; }

header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 20px 30px;
border-radius: 15px;
margin-bottom: 25px;
box-shadow: 0 8px 32px rgba(0,0,0,0.3);
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 15px;
}

.header-left { display: flex; align-items: center; gap: 15px; }
.header-left img { width: 50px; height: 50px; }
.header-title h1 { font-size: 1.6em; margin-bottom: 3px; }
.header-title p { color: #4a9eff; font-size: 0.85em; }

.btn-back {
background: linear-gradient(135deg, #000000 0%, #333333 100%);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 0.9em;
font-weight: 600;
transition: all 0.3s;
text-decoration: none;
display: inline-block;
}

.btn-back:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

.content-card {
background: white;
border-radius: 15px;
padding: 30px;
box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

.alert-readonly {
background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
border: 2px solid #fbbf24;
border-radius: 12px;
padding: 15px 20px;
margin-bottom: 25px;
display: flex;
align-items: center;
gap: 12px;
}

.alert-readonly .icon { font-size: 1.8em; }
.alert-readonly p { color: #92400e; font-size: 0.9em; margin: 0; }

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.stat-card {
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
padding: 25px;
border-radius: 12px;
text-align: center;
border-top: 4px solid #2a5298;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
transition: all 0.3s;
}

.stat-card:hover {
transform: translateY(-5px);
box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.stat-card .icon {
font-size: 3em;
margin-bottom: 10px;
}

.stat-card .number {
font-size: 2.5em;
font-weight: bold;
color: #2a5298;
display: block;
margin-bottom: 5px;
}

.stat-card .label {
font-size: 0.95em;
color: #666;
font-weight: 600;
}

.info-message {
text-align: center;
padding: 60px 20px;
color: #666;
}

.info-message-icon {
font-size: 5em;
margin-bottom: 20px;
opacity: 0.5;
}

.info-message h3 {
color: #333;
margin-bottom: 10px;
font-size: 1.5em;
}

.info-message p {
font-size: 1.05em;
line-height: 1.6;
max-width: 600px;
margin: 0 auto;
}

@media (max-width: 768px) {
header { flex-direction: column; text-align: center; }
.stats-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="container">
<header>
<div class="header-left">
<img src="./logo.png" alt="Logo" onerror="this.style.display='none'">
<div class="header-title">
<h1>ğŸ“Š EstadÃ­sticas y Reportes</h1>
<p>Solo Lectura - CENSA</p>
</div>
</div>
<a href="consulta.html" class="btn-back">â† Volver al Dashboard</a>
</header>

<div class="content-card">
<div class="alert-readonly">
<div class="icon">ğŸ”’</div>
<p><strong>Vista de solo lectura.</strong> Puedes consultar las estadÃ­sticas generales del sistema.</p>
</div>

<div class="stats-grid">
<div class="stat-card">
<div class="icon">ğŸ“‹</div>
<span class="number" id="totalIncidencias">0</span>
<span class="label">Total Incidencias</span>
</div>

<div class="stat-card">
<div class="icon">â°</div>
<span class="number" id="totalTardanzas">0</span>
<span class="label">Total Tardanzas</span>
</div>

<div class="stat-card">
<div class="icon">ğŸ‘¥</div>
<span class="number" id="totalEstudiantes">0</span>
<span class="label">Estudiantes Registrados</span>
</div>

<div class="stat-card">
<div class="icon">ğŸ“…</div>
<span class="number" id="incidenciasMes">0</span>
<span class="label">Incidencias Este Mes</span>
</div>

<div class="stat-card">
<div class="icon">ğŸš¨</div>
<span class="number" id="tardanzasMes">0</span>
<span class="label">Tardanzas Este Mes</span>
</div>

<div class="stat-card">
<div class="icon">ğŸ“ˆ</div>
<span class="number" id="promedio">0%</span>
<span class="label">Tasa de Convivencia</span>
</div>
</div>

<div class="info-message">
<div class="info-message-icon">ğŸ“Š</div>
<h3>EstadÃ­sticas en Tiempo Real</h3>
<p>Las estadÃ­sticas mostradas arriba se actualizan automÃ¡ticamente desde Google Sheets. Para ver reportes mÃ¡s detallados o exportar datos, contacta al administrador del sistema.</p>
</div>
</div>
</div>

<script src="./auth-guard.js"></script>
<script>
let CONFIG = { 
urlIncidencias: 'https://script.google.com/macros/s/AKfycbwnCHIHNum-8uCHLbuE5NvwJeVmVMF6hCLWOAQQRUOwsU5GK_vpkrxifDFlMat1tP-z/exec',
urlTardanzas: 'https://script.google.com/macros/s/AKfycbxI2JCRc-f0MdokDyepK_UOPf_gAbjYpCWzqe6ShqhRIP7uurohjBdswChKHaExsT2Riw/exec',
urlEstudiantes: 'https://script.google.com/macros/s/AKfycby-ceKgHZzTxQzcVcNiOWaN5aNDoqtIlihVcOZAp0_5hIVcv115GKHtfdjFPq43ttCEuA/exec'
};

window.addEventListener('load', function() {
const configGuardada = localStorage.getItem('censaConfig');
if (configGuardada) {
const configTemp = JSON.parse(configGuardada);
if (configTemp.urlIncidencias) CONFIG.urlIncidencias = configTemp.urlIncidencias;
if (configTemp.urlTardanzas) CONFIG.urlTardanzas = configTemp.urlTardanzas;
if (configTemp.urlEstudiantes) CONFIG.urlEstudiantes = configTemp.urlEstudiantes;
console.log('âœ… ConfiguraciÃ³n actualizada desde localStorage');
}
console.log('ğŸ“Š URLs:', CONFIG);

cargarEstadisticas();
});

async function cargarDatosDesdeGoogleSheets(url) {
try {
const response = await fetch(url);
if (!response.ok) throw new Error('Error en la respuesta');
return await response.json();
} catch (error) {
console.error('Error:', error);
return [];
}
}

async function cargarEstadisticas() {
try {
// Cargar incidencias
let incidencias = [];
if (CONFIG.urlIncidencias) {
incidencias = await cargarDatosDesdeGoogleSheets(CONFIG.urlIncidencias);
}

// Cargar tardanzas
let tardanzas = [];
if (CONFIG.urlTardanzas) {
tardanzas = await cargarDatosDesdeGoogleSheets(CONFIG.urlTardanzas);
}

// Cargar estudiantes
let estudiantes = [];
if (CONFIG.urlEstudiantes) {
estudiantes = await cargarDatosDesdeGoogleSheets(CONFIG.urlEstudiantes);
}

// Calcular estadÃ­sticas
const mesActual = new Date().getMonth();
const aÃ±oActual = new Date().getFullYear();

const incidenciasMes = incidencias.filter(inc => {
try {
const fecha = new Date(inc.fecha);
return fecha.getMonth() === mesActual && fecha.getFullYear() === aÃ±oActual;
} catch {
return false;
}
});

const tardanzasMes = tardanzas.filter(tard => {
try {
const fecha = new Date(tard.fecha);
return fecha.getMonth() === mesActual && fecha.getFullYear() === aÃ±oActual;
} catch {
return false;
}
});

// Actualizar UI
document.getElementById('totalIncidencias').textContent = incidencias.length;
document.getElementById('totalTardanzas').textContent = tardanzas.length;
document.getElementById('totalEstudiantes').textContent = estudiantes.length;
document.getElementById('incidenciasMes').textContent = incidenciasMes.length;
document.getElementById('tardanzasMes').textContent = tardanzasMes.length;

// Calcular tasa de convivencia (ejemplo simple)
const tasa = estudiantes.length > 0 
? Math.round(((estudiantes.length - incidenciasMes.length) / estudiantes.length) * 100)
: 0;
document.getElementById('promedio').textContent = tasa + '%';

console.log('âœ… EstadÃ­sticas cargadas');
} catch (error) {
console.error('Error cargando estadÃ­sticas:', error);
}
}

console.log('ğŸ“Š MÃ³dulo de estadÃ­sticas (consulta) cargado');
</script>

</body>
</html>
