<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historial - Consulta</title>
<link rel="icon" type="image/png" href="./logo.png">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
min-height: 100vh;
padding: 20px;
}

.container { max-width: 1400px; margin: 0 auto; }

header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 20px 30px;
border-radius: 15px;
margin-bottom: 25px;
box-shadow: 0 8px 32px rgba(0,0,0,0.3);
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 15px;
}

.header-left { display: flex; align-items: center; gap: 15px; }
.header-left img { width: 50px; height: 50px; }
.header-title h1 { font-size: 1.6em; margin-bottom: 3px; }
.header-title p { color: #4a9eff; font-size: 0.85em; }

.btn-back {
background: linear-gradient(135deg, #000000 0%, #333333 100%);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 0.9em;
font-weight: 600;
transition: all 0.3s;
text-decoration: none;
display: inline-block;
}

.btn-back:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

.content-card {
background: white;
border-radius: 15px;
padding: 30px;
box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

.alert-readonly {
background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
border: 2px solid #fbbf24;
border-radius: 12px;
padding: 15px 20px;
margin-bottom: 25px;
display: flex;
align-items: center;
gap: 12px;
}

.alert-readonly .icon { font-size: 1.8em; }
.alert-readonly p { color: #92400e; font-size: 0.9em; margin: 0; }

.timeline {
position: relative;
padding-left: 30px;
}

.timeline::before {
content: '';
position: absolute;
left: 8px;
top: 0;
bottom: 0;
width: 3px;
background: linear-gradient(180deg, #2a5298 0%, #1e3c72 100%);
}

.timeline-item {
position: relative;
margin-bottom: 30px;
background: #f8f9fa;
padding: 20px;
border-radius: 10px;
border-left: 4px solid #2a5298;
}

.timeline-item::before {
content: '';
position: absolute;
left: -38px;
top: 20px;
width: 15px;
height: 15px;
border-radius: 50%;
background: #2a5298;
border: 3px solid white;
box-shadow: 0 0 0 2px #2a5298;
}

.timeline-date {
font-size: 0.85em;
color: #666;
margin-bottom: 8px;
}

.timeline-content h4 {
color: #000000;
margin-bottom: 5px;
font-size: 1.1em;
}

.timeline-content p {
color: #666;
font-size: 0.95em;
line-height: 1.5;
}

.timeline-type {
display: inline-block;
padding: 4px 12px;
border-radius: 20px;
font-size: 0.8em;
font-weight: 600;
margin-top: 8px;
}

.type-incidencia {
background: #f8d7da;
color: #721c24;
}

.type-tardanza {
background: #fff3cd;
color: #856404;
}

.type-reunion {
background: #d1ecf1;
color: #0c5460;
}

.info-message {
text-align: center;
padding: 60px 20px;
color: #666;
}

.info-message-icon {
font-size: 5em;
margin-bottom: 20px;
opacity: 0.5;
}

@media (max-width: 768px) {
header { flex-direction: column; text-align: center; }
.timeline { padding-left: 30px; }
.timeline::before { left: 10px; }
.timeline-item::before { left: -42px; }
}
</style>
</head>
<body>

<div class="container">
<header>
<div class="header-left">
<img src="./logo.png" alt="Logo" onerror="this.style.display='none'">
<div class="header-title">
<h1>üìú Historial del Sistema</h1>
<p>Solo Lectura - CENSA</p>
</div>
</div>
<a href="consulta.html" class="btn-back">‚Üê Volver al Dashboard</a>
</header>

<div class="content-card">
<div class="alert-readonly">
<div class="icon">üîí</div>
<p><strong>Vista de solo lectura.</strong> Puedes consultar el historial de actividades del sistema.</p>
</div>

<div class="timeline" id="timeline">
<div class="info-message">
<div class="info-message-icon">üìú</div>
<p>Cargando historial de actividades...</p>
</div>
</div>
</div>
</div>

<script src="./auth-guard.js"></script>
<script>
let CONFIG = { 
urlIncidencias: 'https://script.google.com/macros/s/AKfycbwnCHIHNum-8uCHLbuE5NvwJeVmVMF6hCLWOAQQRUOwsU5GK_vpkrxifDFlMat1tP-z/exec',
urlTardanzas: 'https://script.google.com/macros/s/AKfycbxI2JCRc-f0MdokDyepK_UOPf_gAbjYpCWzqe6ShqhRIP7uurohjBdswChKHaExsT2Riw/exec'
};

window.addEventListener('load', function() {
const configGuardada = localStorage.getItem('censaConfig');
if (configGuardada) {
const configTemp = JSON.parse(configGuardada);
if (configTemp.urlIncidencias) CONFIG.urlIncidencias = configTemp.urlIncidencias;
if (configTemp.urlTardanzas) CONFIG.urlTardanzas = configTemp.urlTardanzas;
console.log('‚úÖ Configuraci√≥n actualizada desde localStorage');
}
console.log('üìú URLs:', CONFIG);

cargarHistorial();
});

async function cargarDatosDesdeGoogleSheets(url) {
try {
const response = await fetch(url);
if (!response.ok) throw new Error('Error en la respuesta');
return await response.json();
} catch (error) {
console.error('Error:', error);
return [];
}
}

async function cargarHistorial() {
const timeline = document.getElementById('timeline');

try {
let eventos = [];

// Cargar incidencias
if (CONFIG.urlIncidencias) {
const incidencias = await cargarDatosDesdeGoogleSheets(CONFIG.urlIncidencias);
eventos = eventos.concat(incidencias.map(inc => ({
tipo: 'incidencia',
fecha: inc.fecha,
titulo: `Incidencia registrada: ${inc.estudiante}`,
descripcion: `${inc.tipoConducta} - ${inc.curso}`,
})));
}

// Cargar tardanzas
if (CONFIG.urlTardanzas) {
const tardanzas = await cargarDatosDesdeGoogleSheets(CONFIG.urlTardanzas);
eventos = eventos.concat(tardanzas.map(tard => ({
tipo: 'tardanza',
fecha: tard.fecha,
titulo: `Tardanza registrada: ${tard.estudiante}`,
descripcion: `${tard.curso} - Total en ${tard.mes}: ${tard.totalMes}`,
})));
}

// Ordenar por fecha (m√°s reciente primero)
eventos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

// Limitar a √∫ltimos 50 eventos
eventos = eventos.slice(0, 50);

if (eventos.length === 0) {
timeline.innerHTML = `
<div class="info-message">
<div class="info-message-icon">üì≠</div>
<p>No hay actividades registradas en el historial.</p>
</div>
`;
return;
}

// Mostrar eventos
timeline.innerHTML = eventos.map(evento => `
<div class="timeline-item">
<div class="timeline-date">${formatearFecha(evento.fecha)}</div>
<div class="timeline-content">
<h4>${evento.titulo}</h4>
<p>${evento.descripcion}</p>
<span class="timeline-type type-${evento.tipo}">${evento.tipo}</span>
</div>
</div>
`).join('');

console.log(`‚úÖ Historial cargado: ${eventos.length} eventos`);
} catch (error) {
console.error('Error cargando historial:', error);
timeline.innerHTML = `
<div class="info-message">
<div class="info-message-icon">‚ö†Ô∏è</div>
<p style="color:#dc3545;">Error al cargar el historial. Verifica la configuraci√≥n.</p>
</div>
`;
}
}

function formatearFecha(fechaStr) {
if (!fechaStr) return 'N/A';
try {
const fecha = new Date(fechaStr);
const dia = String(fecha.getDate()).padStart(2, '0');
const mes = String(fecha.getMonth() + 1).padStart(2, '0');
const a√±o = fecha.getFullYear();
const hora = String(fecha.getHours()).padStart(2, '0');
const minutos = String(fecha.getMinutes()).padStart(2, '0');
return `${dia}/${mes}/${a√±o} a las ${hora}:${minutos}`;
} catch (error) {
return fechaStr;
}
}

console.log('üìú M√≥dulo de historial (consulta) cargado');
</script>

</body>
</html>
